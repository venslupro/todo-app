name: Database Migration

on:
  push:
    branches: [ main ]
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch:  # 允许手动触发迁移

jobs:
  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Supabase CLI
      run: |
        curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.deb -o supabase.deb
        sudo dpkg -i supabase.deb

    - name: Link to Supabase project
      run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

    - name: Set Supabase access token
      run: supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}

    - name: Run database migrations
      run: supabase db push
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

    - name: Verify migration
      run: |
        # 简单的验证脚本，检查关键表是否存在
        curl -X GET \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          "${{ secrets.SUPABASE_URL }}/rest/v1/todos?limit=1" \
          || echo "Migration verification completed"

    - name: Notify on success
      if: success()
      run: |
        echo "Database migration completed successfully!"
        # 可以集成Slack、Discord等通知
        # 例如: curl -X POST -H 'Content-type: application/json' --data '{"text":"Database migration successful!"}' $SLACK_WEBHOOK_URL