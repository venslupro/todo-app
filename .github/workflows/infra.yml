name: "Infrastructure as Code - Terraform"

on:
  workflow_dispatch:
    inputs:
      operation:
        description: "Terraform operation to perform"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
  push:
    branches:
      - main
      - '**'

env:
  WORKING_DIRECTORY: infra
  TF_CLI_ARGS: "-no-color"

jobs:
  terraform-plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}

    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: "ï¿½ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "ï¿½ Initialize Terraform"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ”§ Initializing Terraform modules and providers..."
          terraform init -input=false

      - name: "ï¿½ðŸ” Validate Terraform configuration"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ï¿½ Validating Terraform configuration..."
          terraform validate

      - name: "ðŸ“Š Terraform Plan"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        if: github.event.inputs.operation == 'plan' || github.event_name == 'push'
        run: |
          echo "ðŸ“Š Generating Terraform execution plan..."
          terraform plan \
            -input=false \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
            -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
            -var="environment=${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}" \
            -out=terraform.tfplan \
            > /dev/null 2>&1
          
          echo "âœ… Plan generated and saved to terraform.tfplan"

      - name: "ðŸ“¤ Upload Terraform Plan"
        if: github.event.inputs.operation == 'plan' || github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
          path: ${{ env.WORKING_DIRECTORY }}/terraform.tfplan
          retention-days: 30

  terraform-destroy:
    name: "Terraform Destroy"
    runs-on: ubuntu-latest
    needs: terraform-plan
    environment: staging
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'

    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: "ï¿½ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "ï¿½ Initialize Terraform"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ï¿½ Initializing Terraform modules and providers..."
          terraform init -input=false

      - name: "ðŸ§¹ Terraform Destroy"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ§¹ Destroying infrastructure resources for staging environment..."
          terraform destroy \
            -input=false \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
            -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
            -var="environment=staging" \
            -auto-approve

  terraform-apply-main:
    name: "Terraform Apply (Main Branch)"
    runs-on: ubuntu-latest
    needs: terraform-plan
    environment: production
    if: github.event.inputs.operation == 'apply' && github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'

    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: "ï¿½ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "ï¿½ Initialize Terraform"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ”§ Initializing Terraform modules and providers..."
          terraform init -input=false

      - name: "ï¿½ Terraform Apply"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸš€ Applying infrastructure changes to production..."
          terraform apply \
            -input=false \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
            -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
            -var="environment=production" \
            -auto-approve

  terraform-apply-non-main:
    name: "Terraform Apply (Non-Main Branch)"
    runs-on: ubuntu-latest
    needs: [terraform-plan, terraform-destroy]
    environment: staging
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'

    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: "ï¿½ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "ï¿½ Initialize Terraform"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ”§ Initializing Terraform modules and providers..."
          terraform init -input=false

      - name: "ï¿½ Terraform Apply"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸš€ Applying infrastructure changes to staging..."
          terraform apply \
            -input=false \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
            -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
            -var="environment=staging" \
            -auto-approve