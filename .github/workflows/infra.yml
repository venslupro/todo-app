name: "Infrastructure as Code - Terraform"

on:
  workflow_dispatch:
    inputs:
      operation:
        description: "Terraform operation to perform"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
  push:
    branches:
      - main
      - '**'

env:
  WORKING_DIRECTORY: infra
  TF_CLI_ARGS: "-no-color"

jobs:
  terraform-plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}

    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: "ï¿½ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "ï¿½ Initialize Terraform"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ”§ Initializing Terraform modules and providers..."
          terraform init -input=false

      - name: "ï¿½ğŸ” Validate Terraform configuration"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ï¿½ Validating Terraform configuration..."
          terraform validate

      - name: "ğŸ“Š Terraform Plan"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        if: github.event.inputs.operation == 'plan' || github.event_name == 'push'
        run: |
          echo "ğŸ“Š Generating Terraform execution plan..."
          terraform plan \
            -input=false \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
            -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
            -var="environment=${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}" \
            -out=terraform.tfplan \
            > /dev/null 2>&1
          
          echo "âœ… Plan generated and saved to terraform.tfplan"

      - name: "ğŸ“¤ Upload Terraform Plan"
        if: github.event.inputs.operation == 'plan' || github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
          path: ${{ env.WORKING_DIRECTORY }}/terraform.tfplan
          retention-days: 30



  terraform-destroy-staging:
    name: "Terraform Destroy (Staging - Manual)"
    runs-on: ubuntu-latest
    needs: terraform-plan
    environment: staging
    if: github.event.inputs.operation == 'destroy' && github.event_name == 'workflow_dispatch' && github.ref != 'refs/heads/main'

    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: "ï¿½ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "ï¿½ Initialize Terraform"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ”§ Initializing Terraform modules and providers..."
          terraform init -input=false

      - name: "ğŸ“¥ Download Terraform State"
        uses: actions/download-artifact@v4
        with:
          name: terraform-state-staging
          path: ${{ env.WORKING_DIRECTORY }}
        continue-on-error: true

      - name: "ğŸ§¹ Terraform Destroy"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ§¹ Destroying infrastructure resources for staging environment..."
          if [ -f "terraform.tfstate" ]; then
            terraform destroy \
              -input=false \
              -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
              -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
              -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
              -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
              -var="environment=staging" \
              -auto-approve
          else
            echo "âš ï¸ No terraform state file found. Skipping destroy as there are no resources to destroy."
          fi

  terraform-apply:
    name: "Terraform Apply (Manual)"
    runs-on: ubuntu-latest
    needs: terraform-plan
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    if: github.event.inputs.operation == 'apply' && github.event_name == 'workflow_dispatch'

    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: "ï¿½ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "ï¿½ Initialize Terraform"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸ”§ Initializing Terraform modules and providers..."
          terraform init -input=false

      - name: "ï¿½ Terraform Apply"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ğŸš€ Applying infrastructure changes to ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}..."
          terraform apply \
            -input=false \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
            -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
            -var="environment=${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}" \
            -auto-approve

      - name: "ğŸ’¾ Upload Terraform State"
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state-${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
          path: ${{ env.WORKING_DIRECTORY }}/terraform.tfstate
          retention-days: 1

