name: Backend CI/CD Pipeline

on:
  push:
    branches: ['main', 'dev']
    paths-ignore:
      - 'infra/**'
      - 'README.md'
      - '*.md'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip-tests:
        description: 'Skip tests (for emergency deployments)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  WORKING_DIRECTORY: './backend'

jobs:
  lint:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: ğŸ”„ Checkout source code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      working-directory: ${{ env.WORKING_DIRECTORY }}
      
    - name: ğŸ” Run ESLint
      run: npm run lint
      working-directory: ${{ env.WORKING_DIRECTORY }}
      
    - name: âœ… Type checking
      run: npm run type-check
      working-directory: ${{ env.WORKING_DIRECTORY }}

  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && !github.event.inputs.skip-tests)
    
    steps:
    - name: ğŸ”„ Checkout source code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      working-directory: ${{ env.WORKING_DIRECTORY }}
      
    - name: ğŸ§ª Run tests
      run: npm test
      working-directory: ${{ env.WORKING_DIRECTORY }}
      
    - name: ğŸ“Š Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: ${{ env.WORKING_DIRECTORY }}/test-results/
        retention-days: 30

  build:
    name: ğŸ—ï¸ Build Project
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || (github.event_name == 'workflow_dispatch' && github.event.inputs.skip-tests))
    
    steps:
    - name: ğŸ”„ Checkout source code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      working-directory: ${{ env.WORKING_DIRECTORY }}
      
    - name: ğŸ—ï¸ Build project
      run: npm run build
      working-directory: ${{ env.WORKING_DIRECTORY }}
      
    - name: ğŸ’¾ Cache build artifacts
      uses: actions/cache/save@v4
      with:
        path: ${{ env.WORKING_DIRECTORY }}/dist
        key: build-${{ github.sha }}

  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    needs: build
    if: |
      (github.ref == 'refs/heads/dev' && github.event_name == 'push' && needs.build.result == 'success') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    
    steps:
    - name: ğŸ”„ Checkout source code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Restore build artifacts
      uses: actions/cache/restore@v4
      with:
        path: ${{ env.WORKING_DIRECTORY }}/dist
        key: build-${{ github.sha }}
        
    - name: ğŸš€ Deploy to Cloudflare Workers (Staging)
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        environment: staging
        command: deploy
        workingDirectory: ${{ env.WORKING_DIRECTORY }}
      env:
        supabase_url: ${{ vars.SUPABASE_URL }}
        supabase_anon_key: ${{ vars.SUPABASE_ANON_KEY }}
        supabase_service_role_key: ${{ vars.SUPABASE_SERVICE_ROLE_KEY }}

    - name: ğŸ“ Deployment Summary
      run: |
        echo "âœ… Successfully deployed to Staging Environment"
        echo "ğŸ”— Worker URL: https://staging.your-worker.workers.dev"
        echo "ğŸ“Š GitHub Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      if: success()

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    needs: build
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') ||
      (github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.build.result == 'success')
    
    steps:
    - name: ğŸ”„ Checkout source code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Restore build artifacts
      uses: actions/cache/restore@v4
      with:
        path: ${{ env.WORKING_DIRECTORY }}/dist
        key: build-${{ github.sha }}
      
    - name: ğŸ›¡ï¸ Production Deployment Pre-check
      run: |
        echo "ğŸš¨ Production Deployment Checklist:"
        echo "1. âœ… All tests passed"
        echo "2. âœ… Code quality checks passed"
        echo "3. âœ… Build successful"
        echo "4. ğŸ“… Deploying on $(date)"
        echo "ğŸ” Last commit: ${{ github.event.head_commit.message }}"
        
    - name: ğŸš€ Deploy to Cloudflare Workers (Production)
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: deploy
        workingDirectory: ${{ env.WORKING_DIRECTORY }}
      env:
        SUPABASE_URL: ${{ vars.SUPABASE_URL_PRODUCTION }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY_PRODUCTION }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PRODUCTION }}
        
    - name: ğŸ“ Deployment Summary
      run: |
        echo "âœ… Successfully deployed to Production Environment"
        echo "ğŸ”— Worker URL: https://production.your-worker.workers.dev"
        echo "ğŸ“Š GitHub Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      if: success()