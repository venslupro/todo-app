name: Backend CI/CD Pipeline

# Backend CI/CD Pipeline for Staging and Production Environments
# Staging: Runs automatically on all branches except main
# Production: Runs only on main branch, deployment is manual

on:
  # Trigger on push to any branch
  push:
    branches: ['main', 'dev']  # ÈôêÂà∂Âú®mainÂíådevÂàÜÊîØËøêË°å
    paths-ignore:
      - 'infra/**'
  
  # Manual trigger for deployment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # Job 1: Code Quality Check
  lint:
    name: üîç Code Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push'  # Always run on push
    
    steps:
    - name: üîÑ Checkout source code
      uses: actions/checkout@v4
      
    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: üì¶ Install project dependencies
      run: npm ci
      working-directory: backend
      
    - name: üîç Run ESLint code analysis
      run: npm run lint
      working-directory: backend
      
    - name: ‚úÖ Run TypeScript type checking
      run: npm run type-check
      working-directory: backend

  # Job 2: Build and Test
  build-and-test:
    name: üèóÔ∏è Build and Test
    runs-on: ubuntu-latest
    needs: lint  # Depends on lint job
    if: github.event_name == 'push'  # Always run on push
    
    steps:
    - name: üîÑ Checkout source code
      uses: actions/checkout@v4
      
    - name: ‚öôÔ∏è Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: üì¶ Install project dependencies
      run: npm ci
      working-directory: backend
      
    - name: üèóÔ∏è Build project
      run: npm run build
      working-directory: backend
      
    - name: üß™ Run unit tests
      run: npm test
      working-directory: backend
      
    - name: üì§ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-build
        path: backend/dist/
        retention-days: 7

  # Job 3: Staging Deployment (Auto on non-main branches)
  deploy-staging:
    name: üöÄ Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    needs: build-and-test  # Depends on build-and-test job
    if: github.ref != 'refs/heads/main' && github.event_name == 'push'  # Auto run on non-main branches only
    
    steps:
    - name: üîÑ Checkout source code
      uses: actions/checkout@v4
      
    - name: ‚öôÔ∏è Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: üì¶ Install project dependencies
      run: npm ci
      working-directory: backend
      
    - name: üèóÔ∏è Build project
      run: npm run build
      working-directory: backend
      
    - name: üîê Setup Cloudflare Wrangler for Staging
      run: |
        npm ci
        # Debug: List available secrets with more details
        echo "=== GitHub Secrets Debug Information ==="
        echo "Branch: ${{ github.ref }}"
        echo "Event: ${{ github.event_name }}"
        echo "Available GitHub Secrets:"
        echo "CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN != '' && 'SET' || 'NOT SET' }}"
        echo "CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID != '' && 'SET' || 'NOT SET' }}"
        echo "SUPABASE_URL_STAGING: ${{ secrets.SUPABASE_URL_STAGING != '' && 'SET' || 'NOT SET' }}"
        echo "SUPABASE_ANON_KEY_STAGING: ${{ secrets.SUPABASE_ANON_KEY_STAGING != '' && 'SET' || 'NOT SET' }}"
        echo "SUPABASE_SERVICE_ROLE_KEY_STAGING: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_STAGING != '' && 'SET' || 'NOT SET' }}"
        
        # Test if secrets are accessible by checking length
        echo "=== Secrets Length Check ==="
        echo "CLOUDFLARE_API_TOKEN length: ${#CLOUDFLARE_API_TOKEN}"
        echo "CLOUDFLARE_ACCOUNT_ID length: ${#CLOUDFLARE_ACCOUNT_ID}"
        
        # Verify Cloudflare API token is available
        if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
          echo "‚ùå CLOUDFLARE_API_TOKEN is not set in GitHub Secrets"
          echo "=== Troubleshooting Steps ==="
          echo "1. Go to Repository Settings -> Secrets and variables -> Actions"
          echo "2. Check that ALL secrets are named EXACTLY as shown above"
          echo "3. Ensure secrets are saved (not just typed in the input field)"
          echo "4. Check if you have permission to access secrets on this branch"
          echo "5. Try re-saving the secrets to clear any cache"
          exit 1
        fi
        
        echo "‚úÖ All required secrets are available"
        # Test authentication
        CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}" CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" npx wrangler whoami
      working-directory: backend
        
    - name: üöÄ Deploy to Staging Environment
      run: |
        # Deploy with explicit environment variable setting
        CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}" \
        CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
        SUPABASE_URL="${{ secrets.SUPABASE_URL_STAGING }}" \
        SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY_STAGING }}" \
        SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY_STAGING }}" \
        npx wrangler deploy src/index.ts --env staging
      working-directory: backend
      
    - name: üìã Display staging deployment info
      run: |
        echo "‚úÖ Staging deployment completed!"
        echo "Branch: ${{ github.ref }}"
        echo "Time: $(date)"

  # Job 4: Production Deployment (Manual on main branch only)
  deploy-production:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    needs: build-and-test  # Depends on build-and-test job
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production' && github.ref == 'refs/heads/main'  # Manual production trigger on main branch only
    
    steps:
    - name: üîÑ Checkout source code
      uses: actions/checkout@v4
      
    - name: ‚öôÔ∏è Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: üì¶ Install project dependencies
      run: npm ci
      working-directory: backend
      
    - name: üèóÔ∏è Build project
      run: npm run build
      working-directory: backend
      
    - name: üîê Setup Cloudflare Wrangler for Production
      run: |
        npm ci
        # Verify Cloudflare API token is available
        if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
          echo "‚ùå CLOUDFLARE_API_TOKEN is not set in GitHub Secrets"
          exit 1
        fi
        # Test authentication
        CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}" CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" npx wrangler whoami
      working-directory: backend
        
    - name: üöÄ Deploy to Production Environment
      run: |
        # Deploy with explicit environment variable setting
        CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}" \
        CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
        SUPABASE_URL="${{ secrets.SUPABASE_URL_PRODUCTION }}" \
        SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY_PRODUCTION }}" \
        SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PRODUCTION }}" \
        npx wrangler deploy src/index.ts --env production
      working-directory: backend
      
    - name: üìã Display production deployment info
      run: |
        echo "‚úÖ Production deployment completed!"
        echo "Branch: ${{ github.ref }}"
        echo "Time: $(date)"