# Terraform Infrastructure Deployment Workflow
# This workflow manages infrastructure deployment using Terraform for production environment only.
# It ensures safe deployments by validating changes and only applying on main branch.
# Note: This workflow does NOT run on pull requests to prevent unnecessary executions

name: "ðŸ”§ Terraform Infrastructure"

# Trigger configuration for infrastructure changes
on:
  # Trigger on push to main branch only when infrastructure files change
  push:
    branches: [main, dev]
    paths:
      - 'infra/**'
      - '.github/workflows/terraform.yml'
  
  # Disable pull_request trigger to prevent unnecessary executions
  # pull_request:
  #   branches: [main]
  #   paths:
  #     - 'infra/**'
  #     - '.github/workflows/terraform.yml'
  
  # Manual trigger for deployment operations
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
      operation:
        description: 'Operation to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply
          - destroy

# Global environment variables
env:
  TF_VERSION: "1.7.4"
  WORKING_DIRECTORY: "infra"

jobs:
  # ============================================================================
  # Infrastructure Validation Job
  # Validates directory structure and configuration files
  # ============================================================================
  
  infrastructure-validation:
    name: "ðŸ” Infrastructure Validation"
    runs-on: ubuntu-latest
    
    # Run on all branches and pull requests
    if: always()
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ“ Validate Directory Structure"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ” Validating infrastructure directory structure..."
          chmod +x scripts/validate-structure.sh
          ./scripts/validate-structure.sh

      - name: "âš¡ Quick Configuration Check"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ” Performing quick configuration validation..."
          chmod +x scripts/simple-validate.sh
          ./scripts/simple-validate.sh

      - name: "ðŸ“‹ Validation Summary"
        run: |
          echo "## Infrastructure Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Directory structure validation passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Quick configuration check completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ All infrastructure files are properly structured" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Terraform Setup Job
  # Sets up Terraform and configures credentials
  # ============================================================================
  
  terraform-setup:
    name: "ï¿½ Terraform Setup"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    needs: infrastructure-validation
    
    # Only run on main branch or when manually triggered
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: "ðŸ”‘ Configure Cloudflare credentials"
        run: |
          echo "ðŸ”‘ Configuring Cloudflare credentials..."
          echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV
          echo "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" >> $GITHUB_ENV

      - name: "ðŸ”‘ Configure Supabase credentials"
        run: |
          echo "ðŸ”‘ Configuring Supabase credentials..."
          echo "SUPABASE_ACCESS_TOKEN=${{ secrets.SUPABASE_ACCESS_TOKEN }}" >> $GITHUB_ENV

      - name: "ðŸ“‹ Setup Summary"
        run: |
          echo "## Terraform Setup Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Terraform version ${{ env.TF_VERSION }} configured" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Cloudflare credentials configured" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Supabase credentials configured" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Terraform Initialization Job
  # Initializes Terraform backend and modules
  # ============================================================================
  
  terraform-init:
    name: "ðŸ“‹ Terraform Initialization"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    needs: terraform-setup
    
    # Only run on main branch or when manually triggered
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: "ï¿½ Cache Terraform"
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/.terraform
            ${{ env.WORKING_DIRECTORY }}/terraform.tfstate
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: "ï¿½ Terraform Init"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init -reconfigure

      - name: "ðŸ“„ Init Summary"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "## Terraform Initialization Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Terraform initialized successfully" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Terraform Validation Job
  # Validates Terraform configuration syntax
  # ============================================================================
  
  terraform-validate:
    name: "ðŸ” Terraform Validation"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    needs: terraform-init
    
    # Only run on main branch or when manually triggered
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: "ðŸ” Terraform Validate"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ” Validating Terraform configuration..."
          terraform validate

      - name: "ðŸ“‹ Validation Summary"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "## Terraform Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Terraform configuration validation passed" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Terraform Plan Job
  # Generates Terraform plan for validation and review
  # ============================================================================
  
  terraform-plan:
    name: "ðŸ“Š Terraform Plan"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    needs: terraform-validate
    
    # Only run on main branch or when manually triggered
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: "ï¿½ Cache Terraform"
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORKING_DIRECTORY }}/.terraform
            ${{ env.WORKING_DIRECTORY }}/terraform.tfstate
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: "ðŸ“Š Terraform Plan"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ“Š Generating Terraform execution plan..."
          terraform plan \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="api_domain=api.todoapp.com" \
            -var="web_domain=app.todoapp.com" \
            -var="zone_name=todoapp.com" \
            -out=terraform.tfplan

      - name: "ðŸ’¾ Upload Terraform Plan"
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || 'production' }}
          path: ${{ env.WORKING_DIRECTORY }}/terraform.tfplan
          retention-days: 30

      - name: "ðŸ“„ Generate Plan Summary"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ“„ Generating plan summary..."
          terraform show -no-color terraform.tfplan > plan-summary.txt
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat plan-summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Terraform Apply Job
  # Applies infrastructure changes (manual trigger only for main branch)
  # ============================================================================
  
  terraform-apply:
    name: "ðŸš€ Terraform Apply"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    needs: terraform-plan
    
    # Only run on main branch with manual trigger for safety
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: " Download Terraform Plan"
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || 'production' }}
          path: ${{ env.WORKING_DIRECTORY }}

      - name: "ðŸš€ Terraform Apply"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸš€ Applying infrastructure changes..."
          terraform apply -auto-approve terraform.tfplan

      - name: "ðŸ“„ Generate Apply Summary"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ“„ Generating apply summary..."
          terraform output -json > outputs.json
          echo "## Terraform Apply Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat outputs.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Infrastructure deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Terraform Destroy Job
  # Destroys infrastructure (manual trigger only for safety)
  # ============================================================================
  
  terraform-destroy:
    name: "ðŸ§¹ Terraform Destroy"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    needs: terraform-setup
    
    # Only run on manual triggers for safety
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: "ðŸ”‘ Configure Cloudflare credentials"
        run: |
          echo "ðŸ”‘ Configuring Cloudflare credentials..."
          echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV
          echo "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" >> $GITHUB_ENV

      - name: "ðŸ”‘ Configure Supabase credentials"
        run: |
          echo "ðŸ”‘ Configuring Supabase credentials..."
          echo "SUPABASE_ACCESS_TOKEN=${{ secrets.SUPABASE_ACCESS_TOKEN }}" >> $GITHUB_ENV

      - name: "ðŸ“‹ Terraform Init"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init -backend=false

      - name: "âš ï¸ Confirm Destruction"
        run: |
          echo "âš ï¸ Confirming infrastructure destruction..."
          echo "## âš ï¸ Infrastructure Destruction Warning" >> $GITHUB_STEP_SUMMARY
          echo "This will DESTROY all infrastructure in ${{ github.event.inputs.environment || 'production' }} environment" >> $GITHUB_STEP_SUMMARY
          echo "**This action cannot be undone!**" >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ§¹ Terraform Destroy"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ§¹ Destroying infrastructure resources..."
          terraform destroy \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="api_domain=api.todoapp.com" \
            -var="web_domain=app.todoapp.com" \
            -var="zone_name=todoapp.com" \
            -auto-approve

      - name: "ðŸ“„ Destruction Summary"
        run: |
          echo "ðŸ“„ Generating destruction summary..."
          echo "## ðŸ§¹ Infrastructure Destruction Complete" >> $GITHUB_STEP_SUMMARY
          echo "### Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "All infrastructure resources have been destroyed." >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Make sure to update any application configurations that depend on these resources." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Dev Branch Validation Job
  # Validates infrastructure changes on dev branch without creating resources
  # ============================================================================
  
  dev-branch-validation:
    name: "ðŸ”¬ Dev Branch Validation"
    runs-on: ubuntu-latest
    
    # Only run on dev branch
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ“ Validate Directory Structure"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ” Validating infrastructure directory structure..."
          chmod +x scripts/validate-structure.sh
          ./scripts/validate-structure.sh

      - name: "âš¡ Quick Configuration Check"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ” Performing quick configuration validation..."
          chmod +x scripts/simple-validate.sh
          ./scripts/simple-validate.sh

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: "ðŸ“‹ Terraform Init"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init -backend=false

      - name: "ðŸ” Terraform Validate"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ” Validating Terraform configuration..."
          terraform validate

      - name: "ðŸ“Š Terraform Plan (Dry Run)"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ“Š Generating Terraform execution plan (dry run)..."
          terraform plan \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="api_domain=dev-api.todoapp.com" \
            -var="web_domain=dev-app.todoapp.com" \
            -var="zone_name=todoapp.com" \
            -out=dev-terraform.tfplan

      - name: "ðŸ“„ Dev Validation Summary"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ“„ Generating dev branch validation summary..."
          terraform show -no-color dev-terraform.tfplan > dev-plan-summary.txt
          echo "## ðŸ”¬ Dev Branch Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: dev" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure validation completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Terraform plan generated (dry run only)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Ready for deployment to main branch" >> $GITHUB_STEP_SUMMARY