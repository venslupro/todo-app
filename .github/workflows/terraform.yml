name: "Infrastructure as Code - Terraform"

on:
  workflow_dispatch:
    inputs:
      operation:
        description: "Terraform operation to perform"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
  push:

env:
  WORKING_DIRECTORY: infra
  TF_CLI_ARGS: "-no-color"

jobs:
  terraform:
    name: "Terraform ${{ github.event.inputs.operation || 'plan' }}"
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: "ðŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: "ï¿½ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "ï¿½ Initialize Terraform"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ”§ Initializing Terraform modules and providers..."
          terraform init -input=false

      - name: "ï¿½ðŸ” Validate Terraform configuration"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ï¿½ Validating Terraform configuration..."
          terraform validate

      - name: "ðŸ“Š Terraform Plan"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        if: github.event.inputs.operation == 'plan' || github.event_name == 'push'
        run: |
          echo "ðŸ“Š Generating Terraform execution plan..."
          terraform plan \
            -input=false \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
            -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
            -var="api_domain=${{ vars.API_DOMAIN || 'api.todoapp.com' }}" \
            -var="web_domain=${{ vars.WEB_DOMAIN || 'app.todoapp.com' }}" \
            -var="zone_name=${{ vars.ZONE_NAME || 'todoapp.com' }}" \
            -var="existing_bucket_name=${{ vars.EXISTING_BUCKET_NAME || 'todo-app-storage' }}" \
            -out=terraform.tfplan

      - name: "ðŸ“¤ Upload Terraform Plan"
        if: github.event.inputs.operation == 'plan' || github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || 'production' }}
          path: ${{ env.WORKING_DIRECTORY }}/terraform.tfplan
          retention-days: 30

      - name: "ï¿½ Terraform Apply"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        if: github.event.inputs.operation == 'apply' && github.event.inputs.environment == 'production'
        run: |
          echo "ðŸš€ Applying infrastructure changes to production..."
          terraform apply \
            -input=false \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
            -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
            -var="supabase_existing_project_id=${{ vars.SUPABASE_EXISTING_PROJECT_ID || secrets.SUPABASE_EXISTING_PROJECT_ID || '' }}" \
            -var="api_domain=${{ vars.API_DOMAIN || 'api.todoapp.com' }}" \
            -var="web_domain=${{ vars.WEB_DOMAIN || 'app.todoapp.com' }}" \
            -var="zone_name=${{ vars.ZONE_NAME || 'todoapp.com' }}" \
            -var="existing_bucket_name=${{ vars.EXISTING_BUCKET_NAME || 'todo-app-storage' }}" \
            -auto-approve

      - name: "ðŸ“‹ Print Configuration Variables (Destroy)"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        if: github.event.inputs.operation == 'destroy'
        run: |
          echo "âš ï¸  WARNING: This will DESTROY all infrastructure resources!"
          echo "âš ï¸  Confirm this action is intentional before proceeding."

      - name: "ðŸ§¹ Terraform Destroy"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        if: github.event.inputs.operation == 'destroy'
        run: |
          # Safety check for production environment
          if [ "${{ github.event.inputs.environment || 'production' }}" = "production" ]; then
            echo "âŒ ERROR: Destroy operation is not allowed in production environment!"
            echo "   Use a different environment for testing destroy operations."
            exit 1
          fi
          
          echo "ðŸ§¹ Destroying infrastructure resources..."
          terraform destroy \
            -input=false \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="supabase_access_token=${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -var="supabase_organization_id=${{ secrets.SUPABASE_ORGANIZATION_ID }}" \
            -var="supabase_database_password=${{ secrets.SUPABASE_DATABASE_PASSWORD }}" \
            -var="api_domain=${{ vars.API_DOMAIN || 'api.todoapp.com' }}" \
            -var="web_domain=${{ vars.WEB_DOMAIN || 'app.todoapp.com' }}" \
            -var="zone_name=${{ vars.ZONE_NAME || 'todoapp.com' }}" \
            -var="existing_bucket_name=${{ vars.EXISTING_BUCKET_NAME || 'todo-app-storage' }}" \
            -auto-approve

      - name: "ðŸ“Š Operations Summary"
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "## Terraform Operations Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "### Operation: ${{ github.event.inputs.operation || 'plan' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.operation }}" = "plan" ] || [ "${{ github.event_name }}" = "push" ]; then
            echo "### Plan Status: Generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "### Artifact: terraform-plan-${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.operation }}" = "apply" ]; then
            echo "### Apply Status: Completed successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.operation }}" = "destroy" ]; then
            echo "### Destroy Status: Completed successfully" >> $GITHUB_STEP_SUMMARY
          fi