name: Manual Deployment

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - production
      version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string

jobs:
  deploy:
    name: ğŸš€ Deploy to Cloudflare Workers
    runs-on: ubuntu-latest
    
    steps:
    # é˜¶æ®µ1: å‡†å¤‡ç¯å¢ƒ
    - name: ğŸ”„ Checkout source code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: ğŸ“¦ Install project dependencies
      run: npm ci
      working-directory: backend
      
    - name: ğŸ—ï¸ Build project
      run: npm run build
      working-directory: backend
      
    # é˜¶æ®µ2: éƒ¨ç½²åˆ°ä¸åŒç¯å¢ƒ
    - name: ğŸ” Setup Cloudflare Wrangler
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        
    - name: ğŸš€ Deploy to ${{ github.event.inputs.environment }}
      run: |
        if [ "${{ github.event.inputs.environment }}" = "production" ]; then
          npx wrangler deploy --env production
        else
          npx wrangler deploy --env development
        fi
      working-directory: backend
      
    - name: ğŸ“‹ Display deployment info
      run: |
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "ç¯å¢ƒ: ${{ github.event.inputs.environment }}"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version || 'latest' }}"
        echo "æ—¶é—´: $(date)"